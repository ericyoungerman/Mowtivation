---
title: "Weed biomass"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.path = "figs/analysis/weed_biomass-"
)
```
#Packages/setup
```{r setup, message=FALSE, warning=FALSE}

# packages only once
library(tidyverse)
library(janitor)
library(readxl)
library(glmmTMB)
library(DHARMa)
library(emmeans)
library(multcomp)
library(car)
library(kableExtra)
library(here)##install.packages("here")
library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)


# helper: tidy emmeans regardless of CI column names
tidy_emm <- function(emm_df, ref_levels = NULL) {
  lcl_col <- intersect(c("lower.CL", "asymp.LCL"), names(emm_df))[1]
  ucl_col <- intersect(c("upper.CL", "asymp.UCL"), names(emm_df))[1]
  if (is.na(lcl_col) || is.na(ucl_col)) {
    stop("Could not find CI columns in emmeans output.")
  }
  out <- emm_df %>%
    mutate(
      ci_low  = .data[[lcl_col]],
      ci_high = .data[[ucl_col]]
    )
  if (!is.null(ref_levels)) {
    out <- out %>%
      mutate(weed_trt = factor(weed_trt, levels = ref_levels))
  }
  out
}

```

<br>

### 1. Data import & prep


``` {r}
# 1) read + clean master
soy_all <- readxl::read_excel("~/Github/Mowtivation/data/raw/All Treatments/combined_raw.xlsx") |>
  janitor::clean_names() |>
  dplyr::rename(weed_trt = treatment) |>
  dplyr::mutate(
    weed_trt = dplyr::recode(
      weed_trt,
      "RNO" = "Rolled, no control",
      "RIM" = "Rolled + mowing",
      "RIC" = "Rolled + high-residue cult.",
      "TIM" = "Tilled + mowing",
      "TIC" = "Tilled + cultivation"
    ),
    # make site-year
    site_year = interaction(year, location, drop = TRUE),
    site_year = factor(site_year),
    block     = factor(block),
    # convert to kg/ha from 0.5 m2
    weed_biomass_kg_ha         = (weed_biomass            / 0.5) * 10000 / 1000,
    inrow_weed_biomass_kg_ha   = (inrow_weed_biomass      / 0.5) * 10000 / 1000,
    interrow_weed_biomass_kg_ha = (interrow_weed_biomass  / 0.5) * 10000 / 1000
  )

# 2) lock in agronomic order (use the same levels in both objects)
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

soy_all <- soy_all |>
  dplyr::mutate(
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 3) make the 2023 Field V subset
soy_field_v_2023 <- soy_all |>
  dplyr::filter(year == 2023, location == "field v") |>
  dplyr::mutate(
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# quick check
knitr::kable(head(soy_all), caption = "All site-years, cleaned")
knitr::kable(head(soy_field_v_2023), caption = "Field V only, 2023")


```
<br>
# Model testing
### Exploratory: 
####Total raw by site-year

```{r}
# table
# 1) table
soy_all |>
  dplyr::group_by(site_year, weed_trt) |>
  dplyr::summarise(
    n      = dplyr::n(),
    mean   = mean(weed_biomass_kg_ha, na.rm = TRUE),
    median = median(weed_biomass_kg_ha, na.rm = TRUE),
    sd     = sd(weed_biomass_kg_ha, na.rm = TRUE),
    .groups = "drop"
  ) |>
  dplyr::arrange(site_year, weed_trt) |>
  knitr::kable(digits = 1, caption = "Raw weed biomass (kg/ha) by site-year × treatment")

# 2) faceted boxplot
ggplot(soy_all, aes(x = weed_trt, y = weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Weed biomass by treatment, each site-year"
  ) +
  theme_classic(base_size = 14)

soy_field_v_2023 |>
  ggplot(aes(x = weed_trt, y = weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Weed biomass by treatment, 2023 – Field V"
  ) +
  theme_classic(base_size = 14)

```
#### In-row raw by site-year
```{r}
# 1) raw table: in-row weed biomass by site-year × treatment ----------
soy_all |>
  dplyr::group_by(site_year, weed_trt) |>
  dplyr::summarise(
    n      = dplyr::n(),
    mean   = mean(inrow_weed_biomass_kg_ha, na.rm = TRUE),
    median = median(inrow_weed_biomass_kg_ha, na.rm = TRUE),
    sd     = sd(inrow_weed_biomass_kg_ha, na.rm = TRUE),
    .groups = "drop"
  ) |>
  dplyr::arrange(site_year, weed_trt) |>
  knitr::kable(
    digits  = 1,
    caption = "Raw in-row weed biomass (kg/ha) by site-year × treatment"
  )

# 2) faceted boxplot: all site-years ----------------------------------
ggplot(soy_all, aes(x = weed_trt, y = inrow_weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "In-row weed biomass (kg/ha)",
    title = "In-row weed biomass by treatment, each site-year"
  ) +
  theme_classic(base_size = 14)

# 3) single high-pressure site (Field V, 2023) ------------------------
soy_field_v_2023 |>
  ggplot(aes(x = weed_trt, y = inrow_weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "In-row weed biomass (kg/ha)",
    title = "In-row weed biomass by treatment, 2023 Field V"
  ) +
  theme_classic(base_size = 14)



```
#### Interrow raw by site-year
```{r}
# 1) raw table
soy_all |>
  dplyr::group_by(site_year, weed_trt) |>
  dplyr::summarise(
    n      = dplyr::n(),
    mean   = mean(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    median = median(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    sd     = sd(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    .groups = "drop"
  ) |>
  dplyr::arrange(site_year, weed_trt) |>
  knitr::kable(
    digits  = 1,
    caption = "Raw interrow weed biomass (kg/ha) by site-year × treatment"
  )

# 2) faceted boxplot: all site-years ----------------------------------
ggplot(soy_all, aes(x = weed_trt, y = interrow_weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Interrow weed biomass (kg/ha)",
    title = "Interrow weed biomass by treatment, each site-year"
  ) +
  theme_classic(base_size = 14)

# 3) single high-pressure site (Field V, 2023) ------------------------
soy_field_v_2023 |>
  ggplot(aes(x = weed_trt, y = interrow_weed_biomass_kg_ha)) +
  geom_boxplot(outlier.shape = NA, width = 0.55, color = "black") +
  geom_jitter(width = 0.12, height = 0, alpha = 0.4, size = 1.8) +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Interrow weed biomass (kg/ha)",
    title = "Interrow weed biomass by treatment, 2023 Field V"
  ) +
  theme_classic(base_size = 14)

```

### Selection
####Total pooled
```{r}

options(contrasts = c("contr.sum", "contr.poly"))

form_all <- weed_biomass_kg_ha ~ weed_trt * site_year + (1 | site_year:block)

# fit models ---------------------------------------------------------
m_all_tw <- soy_all |>
  (\(d) glmmTMB(
    formula = form_all,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_all_nb <- soy_all |>
  (\(d) glmmTMB(
    formula = form_all,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_all_tw_zi <- soy_all |>
  (\(d) glmmTMB(
    formula   = form_all,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

m_all_tw_disp <- soy_all |>
  (\(d) glmmTMB(
    formula     = form_all,
    family      = tweedie(link = "log"),
    ziformula   = ~ 1,
    dispformula = ~ site_year,
    data        = d
  ))()

# helper to get AIC safely -------------------------------------------
safe_aic <- \(mod) {
  out <- try(AIC(mod), silent = TRUE)
  if (inherits(out, "try-error")) return(NA_real_)
  out
}

aic_all <- tibble::tibble(
  model = c(
    "ALL: Tweedie",
    "ALL: NB2",
    "ALL: Tweedie + ZI",
    "ALL: Tweedie + ZI + disp(site_year)"
  ),
  AIC = c(
    safe_aic(m_all_tw),
    safe_aic(m_all_nb),
    safe_aic(m_all_tw_zi),
    safe_aic(m_all_tw_disp)
  )
)

knitr::kable(aic_all, digits = 1,
             caption = "Pooled (all site-years) weed biomass: model AICs")

# model selection (NA-safe) ------------------------------------------
best_all   <- m_all_tw
best_all_n <- "ALL: Tweedie"
best_aic   <- safe_aic(m_all_tw)

# candidate list
cands <- list(
  "ALL: NB2"                         = list(mod = m_all_nb,      aic = safe_aic(m_all_nb)),
  "ALL: Tweedie + ZI"                = list(mod = m_all_tw_zi,   aic = safe_aic(m_all_tw_zi)),
  "ALL: Tweedie + ZI + disp(site_yr)" = list(mod = m_all_tw_disp, aic = safe_aic(m_all_tw_disp))
)

for (nm in names(cands)) {
  this_aic <- cands[[nm]]$aic
  if (is.finite(this_aic) && (this_aic + 2 < best_aic)) {
    best_all   <- cands[[nm]]$mod
    best_all_n <- nm
    best_aic   <- this_aic
  }
}

cat("Selected pooled model:", best_all_n, "\n")

# diagnostics --------------------------------------------------------
res_all <- DHARMa::simulateResiduals(best_all)
plot(res_all)
DHARMa::testDispersion(best_all)
DHARMa::testZeroInflation(best_all)

car::Anova(best_all, type = 3)


```
####Total 2023 
```{r}
# ------------------------------------------------------------
# 2. HIGH-PRESSURE SITE (Field V, 2023 only)
# simpler structure: no site_year term needed
# ------------------------------------------------------------
form_v23 <- weed_biomass_kg_ha ~ weed_trt + (1 | block)

m_v23_tw <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula = form_v23,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_v23_nb <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula = form_v23,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_v23_tw_zi <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula   = form_v23,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

aic_v23 <- tibble::tibble(
  model = c("V23: Tweedie", "V23: NB2", "V23: Tweedie + ZI"),
  AIC   = c(AIC(m_v23_tw), AIC(m_v23_nb), AIC(m_v23_tw_zi))
)

knitr::kable(aic_v23, digits = 1,
             caption = "2023 Field V weed biomass: model AICs")

# pick best for Field V
best_v23   <- m_v23_tw
best_v23_n <- "V23: Tweedie"

if (AIC(m_v23_nb) + 2 < AIC(best_v23)) {
  best_v23   <- m_v23_nb
  best_v23_n <- "V23: NB2"
}
if (AIC(m_v23_tw_zi) + 2 < AIC(best_v23)) {
  best_v23   <- m_v23_tw_zi
  best_v23_n <- "V23: Tweedie + ZI"
}

cat("Selected Field V model:", best_v23_n, "\n")

# diagnostics for Field V
res_v23 <- DHARMa::simulateResiduals(best_v23)
plot(res_v23)
DHARMa::testDispersion(best_v23)
DHARMa::testZeroInflation(best_v23)

car::Anova(best_v23, type = 3)

```
####In-row pooled
```{r}
#### In-row pooled (all site-years)

options(contrasts = c("contr.sum", "contr.poly"))

# model formula: in-row instead of total
form_all_inrow <- inrow_weed_biomass_kg_ha ~ weed_trt * site_year + (1 | site_year:block)

# 1) fit candidate models ----------------------------------------------
m_all_inrow_tw <- soy_all |>
  (\(d) glmmTMB(
    formula = form_all_inrow,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_all_inrow_nb <- soy_all |>
  (\(d) glmmTMB(
    formula = form_all_inrow,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_all_inrow_tw_zi <- soy_all |>
  (\(d) glmmTMB(
    formula   = form_all_inrow,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

m_all_inrow_tw_disp <- soy_all |>
  (\(d) glmmTMB(
    formula     = form_all_inrow,
    family      = tweedie(link = "log"),
    ziformula   = ~ 1,
    dispformula = ~ site_year,
    data        = d
  ))()

# 2) helper for NA-safe AIC --------------------------------------------
safe_aic <- \(mod) {
  out <- try(AIC(mod), silent = TRUE)
  if (inherits(out, "try-error")) return(NA_real_)
  out
}

# 3) compare AICs ------------------------------------------------------
aic_all_inrow <- tibble::tibble(
  model = c(
    "INROW: Tweedie",
    "INROW: NB2",
    "INROW: Tweedie + ZI",
    "INROW: Tweedie + ZI + disp(site_year)"
  ),
  AIC = c(
    safe_aic(m_all_inrow_tw),
    safe_aic(m_all_inrow_nb),
    safe_aic(m_all_inrow_tw_zi),
    safe_aic(m_all_inrow_tw_disp)
  )
)

knitr::kable(
  aic_all_inrow,
  digits  = 1,
  caption = "Pooled (all site-years) in-row weed biomass: model AICs"
)

# 4) pick best (NA-safe) -----------------------------------------------
best_all_inrow   <- m_all_inrow_tw
best_all_inrow_n <- "INROW: Tweedie"
best_aic_inrow   <- safe_aic(m_all_inrow_tw)

cands_inrow <- list(
  "INROW: NB2"                          = list(mod = m_all_inrow_nb,     aic = safe_aic(m_all_inrow_nb)),
  "INROW: Tweedie + ZI"                 = list(mod = m_all_inrow_tw_zi,  aic = safe_aic(m_all_inrow_tw_zi)),
  "INROW: Tweedie + ZI + disp(site_yr)" = list(mod = m_all_inrow_tw_disp, aic = safe_aic(m_all_inrow_tw_disp))
)

for (nm in names(cands_inrow)) {
  this_aic <- cands_inrow[[nm]]$aic
  if (is.finite(this_aic) && (this_aic + 2 < best_aic_inrow)) {
    best_all_inrow   <- cands_inrow[[nm]]$mod
    best_all_inrow_n <- nm
    best_aic_inrow   <- this_aic
  }
}

cat("Selected pooled in-row model:", best_all_inrow_n, "\n")

# 5) diagnostics -------------------------------------------------------
res_all_inrow <- DHARMa::simulateResiduals(best_all_inrow)
plot(res_all_inrow)
DHARMa::testDispersion(best_all_inrow)
DHARMa::testZeroInflation(best_all_inrow)

# 6) Type III tests ----------------------------------------------------
car::Anova(best_all_inrow, type = 3)

```
####In-row 2023

```{r}
#### 2023 Field V — in-row weed biomass



# model formula: in-row instead of total
form_v23_inrow <- inrow_weed_biomass_kg_ha ~ weed_trt + (1 | block)

# candidate models ----------------------------------------------------
m_v23_inrow_tw <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula = form_v23_inrow,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_v23_inrow_nb <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula = form_v23_inrow,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_v23_inrow_tw_zi <- soy_field_v_2023 |>
  (\(d) glmmTMB(
    formula   = form_v23_inrow,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

# AIC table -----------------------------------------------------------
aic_v23_inrow <- tibble::tibble(
  model = c("V23 INROW: Tweedie", "V23 INROW: NB2", "V23 INROW: Tweedie + ZI"),
  AIC   = c(AIC(m_v23_inrow_tw), AIC(m_v23_inrow_nb), AIC(m_v23_inrow_tw_zi))
)

knitr::kable(
  aic_v23_inrow,
  digits  = 1,
  caption = "2023 Field V in-row weed biomass: model AICs"
)

# pick best -----------------------------------------------------------
best_v23_inrow   <- m_v23_inrow_tw
best_v23_inrow_n <- "V23 INROW: Tweedie"

if (AIC(m_v23_inrow_nb) + 2 < AIC(best_v23_inrow)) {
  best_v23_inrow   <- m_v23_inrow_nb
  best_v23_inrow_n <- "V23 INROW: NB2"
}
if (AIC(m_v23_inrow_tw_zi) + 2 < AIC(best_v23_inrow)) {
  best_v23_inrow   <- m_v23_inrow_tw_zi
  best_v23_inrow_n <- "V23 INROW: Tweedie + ZI"
}

cat("Selected Field V in-row model:", best_v23_inrow_n, "\n")

# diagnostics ---------------------------------------------------------
res_v23_inrow <- DHARMa::simulateResiduals(best_v23_inrow)
plot(res_v23_inrow)
DHARMa::testDispersion(best_v23_inrow)
DHARMa::testZeroInflation(best_v23_inrow)

# Type III
car::Anova(best_v23_inrow, type = 3)

```

####Interrow pooled  
```{r}
options(contrasts = c("contr.sum", "contr.poly"))

# 0) treatment order (same as before)
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 1) make an interrow-only dataset (drop NAs)
soy_ir_all <- soy_all |>
  filter(!is.na(interrow_weed_biomass_kg_ha)) |>
  mutate(
    weed_trt  = factor(weed_trt, levels = mow_levels),
    site_year = factor(site_year),
    block     = factor(block)
  )

# model formula: trt × site-year + block nested
form_ir_all <- interrow_weed_biomass_kg_ha ~ weed_trt * site_year + (1 | site_year:block)

# 2) fit candidate models -----------------------------------------------
m_ir_all_tw <- soy_ir_all |>
  (\(d) glmmTMB(
    formula = form_ir_all,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_ir_all_nb <- soy_ir_all |>
  (\(d) glmmTMB(
    formula = form_ir_all,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_ir_all_tw_zi <- soy_ir_all |>
  (\(d) glmmTMB(
    formula   = form_ir_all,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

m_ir_all_tw_disp <- soy_ir_all |>
  (\(d) glmmTMB(
    formula     = form_ir_all,
    family      = tweedie(link = "log"),
    ziformula   = ~ 1,
    dispformula = ~ site_year,
    data        = d
  ))()

# helper to make AIC NA-safe
safe_aic <- \(mod) {
  out <- try(AIC(mod), silent = TRUE)
  if (inherits(out, "try-error")) return(NA_real_)
  out
}

aic_ir_all <- tibble(
  model = c(
    "IR ALL: Tweedie",
    "IR ALL: NB2",
    "IR ALL: Tweedie + ZI",
    "IR ALL: Tweedie + ZI + disp(site_year)"
  ),
  AIC = c(
    safe_aic(m_ir_all_tw),
    safe_aic(m_ir_all_nb),
    safe_aic(m_ir_all_tw_zi),
    safe_aic(m_ir_all_tw_disp)
  )
)

kable(aic_ir_all, digits = 1,
      caption = "Interrow weed biomass (all site-years): model AICs")

# 3) pick best (NA-safe) -----------------------------------------------
best_ir_all   <- m_ir_all_tw
best_ir_all_n <- "IR ALL: Tweedie"
best_aic      <- safe_aic(m_ir_all_tw)

cands_ir <- list(
  "IR ALL: NB2"                          = list(mod = m_ir_all_nb,      aic = safe_aic(m_ir_all_nb)),
  "IR ALL: Tweedie + ZI"                 = list(mod = m_ir_all_tw_zi,   aic = safe_aic(m_ir_all_tw_zi)),
  "IR ALL: Tweedie + ZI + disp(site_yr)" = list(mod = m_ir_all_tw_disp, aic = safe_aic(m_ir_all_tw_disp))
)

for (nm in names(cands_ir)) {
  this_aic <- cands_ir[[nm]]$aic
  if (is.finite(this_aic) && (this_aic + 2 < best_aic)) {
    best_ir_all   <- cands_ir[[nm]]$mod
    best_ir_all_n <- nm
    best_aic      <- this_aic
  }
}

cat("Selected interrow pooled model:", best_ir_all_n, "\n")

# 4) diagnostics --------------------------------------------------------
res_ir_all <- DHARMa::simulateResiduals(best_ir_all)
plot(res_ir_all)
DHARMa::testDispersion(best_ir_all)
DHARMa::testZeroInflation(best_ir_all)

car::Anova(best_ir_all, type = 3)
```

####Interrow 2023
```{r}
soy_ir_v23 <- soy_ir_all |>
  filter(site_year == "2023.field v")  # adjust level name if different

form_ir_v23 <- interrow_weed_biomass_kg_ha ~ weed_trt + (1 | block)

m_ir_v23_tw <- soy_ir_v23 |>
  (\(d) glmmTMB(
    formula = form_ir_v23,
    family  = tweedie(link = "log"),
    data    = d
  ))()

m_ir_v23_nb <- soy_ir_v23 |>
  (\(d) glmmTMB(
    formula = form_ir_v23,
    family  = nbinom2(link = "log"),
    data    = d
  ))()

m_ir_v23_tw_zi <- soy_ir_v23 |>
  (\(d) glmmTMB(
    formula   = form_ir_v23,
    family    = tweedie(link = "log"),
    ziformula = ~ 1,
    data      = d
  ))()

aic_ir_v23 <- tibble(
  model = c("IR V23: Tweedie", "IR V23: NB2", "IR V23: Tweedie + ZI"),
  AIC   = c(
    AIC(m_ir_v23_tw),
    AIC(m_ir_v23_nb),
    AIC(m_ir_v23_tw_zi)
  )
)

kable(aic_ir_v23, digits = 1,
      caption = "Interrow weed biomass, 2023 Field V: model AICs")

# choose best of 3
best_ir_v23   <- m_ir_v23_tw
best_ir_v23_n <- "IR V23: Tweedie"

if (AIC(m_ir_v23_nb) + 2 < AIC(best_ir_v23)) {
  best_ir_v23   <- m_ir_v23_nb
  best_ir_v23_n <- "IR V23: NB2"
}
if (AIC(m_ir_v23_tw_zi) + 2 < AIC(best_ir_v23)) {
  best_ir_v23   <- m_ir_v23_tw_zi
  best_ir_v23_n <- "IR V23: Tweedie + ZI"
}

cat("Selected interrow Field V model:", best_ir_v23_n, "\n")

res_ir_v23 <- DHARMa::simulateResiduals(best_ir_v23)
plot(res_ir_v23)
DHARMa::testDispersion(best_ir_v23)
DHARMa::testZeroInflation(best_ir_v23)

car::Anova(best_ir_v23, type = 3)
```
###Figures
#### Total model pooled
```{r}
library(dplyr)
library(ggplot2)
library(emmeans)
library(multcomp)
library(forcats)

# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) # color-blind friendly palette mapped to THESE names
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) emmeans BY site-year ----------------------------------------------
emm_all <- emmeans(
  best_all,
  specs = ~ weed_trt | site_year,
  type  = "response"
)

emm_df_all <- emm_all |>
  as.data.frame() |>
  dplyr::mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 4) CLD per site-year (Fisher) + reverse letters ----------------------
cld_all <- multcomp::cld(
  emm_all,
  by      = "site_year",
  adjust  = "none",     # Fisher/LSD style
  Letters = letters
) |>
  as.data.frame() |>
  dplyr::mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  ) |>
  dplyr::arrange(site_year, weed_trt) |>
  dplyr::group_by(site_year) |>
  dplyr::mutate(.group = rev(.group)) |>
  dplyr::ungroup()



# 4) join and plot -----------------------------------------------------
plot_df_all <- emm_df_all %>%
  # ensure we have ymin/ymax and consistent factor levels
  dplyr::mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin = pmax(response - SE, 0),
    ymax = response + SE
  ) %>%
  dplyr::left_join(
    cld_all %>%
      dplyr::mutate(
        weed_trt = factor(weed_trt, levels = mow_levels),
        .group = trimws(.group)
      ) %>%
      dplyr::select(site_year, weed_trt, .group),
    by = c("site_year", "weed_trt")
  )

ggplot(plot_df_all, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(
    aes(y = ymax * 1.08, label = .group),  # <-- use ymax instead of mean+SE
    vjust = 0, fontface = "bold", size = 6
  ) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " \\+ ", "\n+ ")) +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Weed biomass by treatment, separated by site-year",
    caption = "Model-based means ± SE; letters = Fisher CLD within site-year; letters reversed so highest = a."
  ) +
  theme_classic(base_size = 20) +
  theme(
    axis.text.x  = element_text(lineheight = 0.95, margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    plot.title   = element_text(face = "bold"),
    plot.caption = element_text(size = 12)
  ) +
  coord_cartesian(clip = "off")


```


####Total model 2023

```{r}

# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) color-blind friendly palette -------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) emmeans for Field V model ----------------------------------------
emm_v23 <- emmeans(
  best_v23,
  specs = ~ weed_trt,
  type  = "response"
)

emm_df_v23 <- emm_v23 |>
  as.data.frame() |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 4) CLD from multcomp (this is the truth: maybe only a/b) ------------
cld_v23_raw <- multcomp::cld(
  emm_v23,
  adjust  = "none",     # Fisher/LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 5) reverse group labels WITHOUT creating new ones -------------------
# join means + original groups
cld_join <- emm_df_v23 |>
  left_join(cld_v23_raw |> select(weed_trt, .group),
            by = "weed_trt")

# order by response (low -> high)
cld_ordered <- cld_join |>
  arrange(response)

# unique groups in this order (e.g. c("a","b") or c("a","ab","b"))
orig_groups <- unique(cld_ordered$.group)

# reverse them
rev_groups  <- rev(orig_groups)

# make a lookup: old -> new
group_map <- setNames(rev_groups, orig_groups)

# apply the map
cld_final <- cld_join |>
  mutate(.group = group_map[.group])

# 6) plot --------------------------------------------------------------
ggplot(cld_final, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(aes(y = ymax * 1.04, label = .group),
            vjust = 0, size = 4.2) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Weed biomass by treatment — Field V, 2023 (high-pressure site)",
    caption = "Model-based means ± SE; letters = Fisher (adjust = \"none\"); labels reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(lineheight = 0.9))


```
####Total raw 2023
```{r}
library(dplyr)
library(ggplot2)
library(emmeans)
library(multcomp)
library(stringr)

# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) color-blind friendly palette -------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) RAW summary from Field V 2023 ------------------------------------
raw_v23 <- soy_field_v_2023 |>
  group_by(weed_trt) |>
  summarise(
    n    = n(),
    mean = mean(weed_biomass_kg_ha, na.rm = TRUE),
    sd   = sd(weed_biomass_kg_ha, na.rm = TRUE),
    se   = sd / sqrt(n),
    .groups = "drop"
  ) |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 4) CLD from the model (this is where the letters come from) ---------
emm_v23 <- emmeans(
  best_v23,
  specs = ~ weed_trt,
  type  = "response"
)

cld_v23_raw <- multcomp::cld(
  emm_v23,
  adjust  = "none",   # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 5) reverse letters WITHOUT inventing new ones -----------------------
# join model means + letters
cld_join <- as.data.frame(emm_v23) |>
  mutate(weed_trt = factor(weed_trt, levels = mow_levels)) |>
  select(weed_trt, response) |>
  left_join(cld_v23_raw |> select(weed_trt, .group),
            by = "weed_trt")

# order by response low -> high
cld_ordered <- cld_join |>
  arrange(response)

# unique groups in that order (e.g. c("a","b"))
orig_groups <- unique(cld_ordered$.group)
rev_groups  <- rev(orig_groups)
group_map   <- setNames(rev_groups, orig_groups)

cld_final <- cld_join |>
  mutate(.group = group_map[.group])

# 6) now join RAW means + (reversed) letters --------------------------
plot_df <- raw_v23 |>
  left_join(
    cld_final |> select(weed_trt, .group),
    by = "weed_trt"
  )

# 7) plot RAW means with MODEL letters --------------------------------
ggplot(plot_df, aes(x = weed_trt, y = mean, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = pmax(mean - se, 0), ymax = mean + se),
                width = 0.14) +
  geom_text(aes(y = (mean + se) * 1.04, label = .group),
            vjust = 0, fontface = "bold", size = 6) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Total weed biomass",
    caption = ""
  ) +
  theme_classic(base_size = 20) +
  theme(
    axis.text.x  = element_text(lineheight = 0.95, margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    plot.title   = element_text(face = "bold"),
    plot.caption = element_text(size = 12)
  ) +
  coord_cartesian(clip = "off")

# 8) save figs
# 8) save figs
ggsave(
  filename = here::here("figs", "analysis", "fig_weed_biomass_mowing_raw_2023.png"),
  width  = 7.5,
  height = 5.5,
  dpi    = 300
)


```
####  In-row model pooled
```{r}
# 0) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 1) color-blind friendly palette mapped to THESE names ---------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 2) emmeans BY site-year (from in-row model) -------------------------
emm_in_all <- emmeans(
  best_all_inrow,                    # <--- your in-row pooled model
  specs = ~ weed_trt | site_year,
  type  = "response"
)

emm_df_in <- emm_in_all |>
  as.data.frame() |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 3) CLD per site-year (Fisher) + reverse letters ---------------------
cld_in <- multcomp::cld(
  emm_in_all,
  by      = "site_year",
  adjust  = "none",     # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  ) |>
  arrange(site_year, weed_trt) |>
  group_by(site_year) |>
  mutate(.group = rev(.group)) |>
  ungroup()

# 4) join and plot -----------------------------------------------------
plot_df_in <- emm_df_in |>
  left_join(
    cld_in |> select(site_year, weed_trt, .group),
    by = c("site_year", "weed_trt")
  )

ggplot(plot_df_in, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(
    aes(y = ymax * 1.04, label = .group),
    vjust = 0,
    size  = 4.2
  ) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "In-row weed biomass (kg/ha)",
    title = "In-row weed biomass by treatment, separated by site-year",
    caption = "Model-based means ± SE; letters = Fisher (within site-year); letters reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(
    strip.text  = element_text(face = "bold"),
    axis.text.x = element_text(lineheight = 0.9)
  )
```
####In-row model 2023
```{r}
# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) color-blind friendly palette -------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) emmeans for Field V *in-row* model -------------------------------
emm_v23_in <- emmeans(
best_v23_inrow,          # <-- in-row 2023 Field V model
  specs = ~ weed_trt,
  type  = "response"
)

emm_df_v23_in <- emm_v23_in |>
  as.data.frame() |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 4) CLD (Fisher) ------------------------------------------------------
cld_v23_in <- multcomp::cld(
  emm_v23_in,
  adjust  = "none",     # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 5) reverse existing letters so tallest bar = "a" ---------------------
cld_join <- emm_df_v23_in |>
  left_join(
    cld_v23_in |> select(weed_trt, .group),
    by = "weed_trt"
  )

cld_ordered <- cld_join |>
  arrange(response)

orig_groups <- unique(cld_ordered$.group)
rev_groups  <- rev(orig_groups)
group_map   <- setNames(rev_groups, orig_groups)

cld_final_in <- cld_join |>
  mutate(.group = group_map[.group])

# 6) plot --------------------------------------------------------------
ggplot(cld_final_in, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(aes(y = ymax * 1.04, label = .group),
            vjust = 0, size = 4.2) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "In-row weed biomass (kg/ha)",
    title = "In-row weed biomass by treatment — Field V, 2023",
    caption = "Model-based means ± SE; letters = Fisher (adjust = \"none\"); letters reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(lineheight = 0.9))
```

####In-row raw 2023

```{r}
# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) palette -----------------------------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) model-based emmeans + CLD (this drives the letters) --------------
emm_v23_in <- emmeans(
  best_v23_inrow,               # <-- your in-row 2023 Field V model
  specs = ~ weed_trt,
  type  = "response"
)

cld_v23_in <- multcomp::cld(
  emm_v23_in,
  adjust  = "none",             # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 4) reverse letters so tallest bar = "a" ------------------------------
# we’ll do that AFTER we know raw means, so we can sort by raw

# 5) RAW means from the data ------------------------------------------
raw_v23_in <- soy_field_v_2023 |>
  group_by(weed_trt) |>
  summarise(
    n    = n(),
    mean = mean(inrow_weed_biomass_kg_ha, na.rm = TRUE),
    sd   = sd(inrow_weed_biomass_kg_ha, na.rm = TRUE),
    se   = sd / sqrt(n),
    .groups = "drop"
  ) |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 6) join raw means + model letters -----------------------------------
plot_df <- raw_v23_in |>
  left_join(
    cld_v23_in |> select(weed_trt, .group),
    by = "weed_trt"
  )

# 7) reverse letter order based on RAW means (low -> high) ------------
ordered <- plot_df |>
  arrange(mean)

orig_groups <- unique(ordered$.group)   # e.g. c("a","ab","b") or just c("a","b")
rev_groups  <- rev(orig_groups)
group_map   <- setNames(rev_groups, orig_groups)

plot_df <- plot_df |>
  mutate(.group = group_map[.group])

# 8) plot --------------------------------------------------------------
ggplot(plot_df, aes(x = weed_trt, y = mean, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = pmax(mean - se, 0), ymax = mean + se),
                width = 0.14) +
  geom_text(aes(y = (mean + se) * 1.04, label = .group),
            vjust = 0, size = 4.2) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "In-row weed biomass (kg/ha)",
    title = "In-row weed biomass by treatment — Field V, 2023 (raw means)",
    caption = "Bars = raw means ± SE; letters = Fisher from model; letters reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(lineheight = 0.9))
```
####Interrow model pooled
```{r}
# 0) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 1) color-blind friendly palette -------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 2) emmeans from the *interrow* model --------------------------------
emm_ir_all <- emmeans(
  best_ir_all,                  # <-- your model name
  specs = ~ weed_trt | site_year,
  type  = "response"
)

emm_df_ir <- emm_ir_all |>
  as.data.frame() |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 3) CLD per site-year (Fisher) and reverse inside each site-year -----
cld_raw <- multcomp::cld(
  emm_ir_all,
  by      = "site_year",
  adjust  = "none",     # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# reverse letters within each site-year so tallest bar = "a"
cld_rev <- cld_raw |>
  group_split(site_year) |>
  lapply(\(df) {
    df <- df |> arrange(weed_trt)
    og  <- unique(df$.group)
    map <- setNames(rev(og), og)
    df$.group <- unname(map[df$.group])
    df
  }) |>
  bind_rows()

# 4) join and plot -----------------------------------------------------
plot_df_ir <- emm_df_ir |>
  left_join(
    cld_rev |> select(site_year, weed_trt, .group),
    by = c("site_year", "weed_trt")
  )

ggplot(plot_df_ir, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(
    aes(y = ymax * 1.04, label = .group),
    vjust = 0,
    size  = 4.2
  ) +
  facet_wrap(~ site_year, nrow = 1, scales = "free_y") +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Interrow weed biomass (kg/ha)",
    title = "Interrow weed biomass by treatment, separated by site-year",
    caption = "Model-based means ± SE; letters = Fisher (within site-year); letters reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(
    strip.text  = element_text(face = "bold"),
    axis.text.x = element_text(lineheight = 0.9)
  )
```
####Interrow model 2023
```{r}
# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) color-blind friendly palette -------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) emmeans for Field V *interrow* model -----------------------------
emm_ir_v23 <- emmeans(
  best_ir_v23,              # <-- 2023, Field V, INTERROW model
  specs = ~ weed_trt,
  type  = "response"
)

emm_df_ir_v23 <- emm_ir_v23 |>
  as.data.frame() |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    ymin     = pmax(response - SE, 0),
    ymax     = response + SE
  )

# 4) CLD (Fisher) ------------------------------------------------------
cld_ir_v23 <- multcomp::cld(
  emm_ir_v23,
  adjust  = "none",     # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 5) reverse existing letters so tallest bar = "a" ---------------------
cld_join <- emm_df_ir_v23 |>
  left_join(
    cld_ir_v23 |> select(weed_trt, .group),
    by = "weed_trt"
  )

cld_ordered <- cld_join |>
  arrange(response)

orig_groups <- unique(cld_ordered$.group)
rev_groups  <- rev(orig_groups)
group_map   <- setNames(rev_groups, orig_groups)

cld_final_ir <- cld_join |>
  mutate(.group = group_map[.group])

# 6) plot --------------------------------------------------------------
ggplot(cld_final_ir, aes(x = weed_trt, y = response, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.14) +
  geom_text(aes(y = ymax * 1.04, label = .group),
            vjust = 0, size = 4.2) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Interrow weed biomass (kg/ha)",
    title = "Interrow weed biomass by treatment — Field V, 2023",
    caption = "Model-based means ± SE; letters = Fisher (adjust = \"none\"); letters reversed so highest = a."
  ) +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(lineheight = 0.9))
```
####Interrow raw 2023
```{r}
# 1) treatment order ---------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

# 2) palette -----------------------------------------------------------
fill_cols <- c(
  "Rolled, no control"          = "#0072B2",  # blue
  "Rolled + mowing"             = "#009E73",  # green
  "Rolled + high-residue cult." = "#F0E442",  # yellow/gold
  "Tilled + mowing"             = "#CC79A7",  # magenta
  "Tilled + cultivation"        = "#D55E00"   # vermillion
)

# 3) model-based emmeans + CLD (drives the LETTERS) -------------------
emm_ir_v23 <- emmeans(
  best_ir_v23,                  # <-- 2023 Field V INTERROW model
  specs = ~ weed_trt,
  type  = "response"
)

cld_ir_v23 <- multcomp::cld(
  emm_ir_v23,
  adjust  = "none",             # Fisher / LSD
  Letters = letters
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 4) RAW interrow means from the data ---------------------------------
raw_ir_v23 <- soy_field_v_2023 |>
  group_by(weed_trt) |>
  summarise(
    n    = n(),
    mean = mean(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    sd   = sd(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    se   = sd / sqrt(n),
    .groups = "drop"
  ) |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# 5) join RAW means + MODEL letters -----------------------------------
plot_df <- raw_ir_v23 |>
  left_join(
    cld_ir_v23 |> select(weed_trt, .group),
    by = "weed_trt"
  )

# 6) reverse letter order based on RAW means (low -> high) ------------
ordered <- plot_df |>
  arrange(mean)

orig_groups <- unique(ordered$.group)
rev_groups  <- rev(orig_groups)
group_map   <- setNames(rev_groups, orig_groups)

plot_df <- plot_df |>
  mutate(.group = group_map[.group])

# 7) plot --------------------------------------------------------------
ggplot(plot_df, aes(x = weed_trt, y = mean, fill = weed_trt)) +
  geom_col(width = 0.7, color = "black") +
  geom_errorbar(
    aes(ymin = pmax(mean - se, 0), ymax = mean + se),
    width = 0.14
  ) +
  geom_text(
    aes(y = (mean + se) * 1.04, label = .group),
    vjust = 0, fontface = "bold", size = 6) +
  scale_fill_manual(values = fill_cols, guide = "none") +
  scale_x_discrete(labels = \(x) stringr::str_replace_all(x, " ", "\n")) +
  labs(
    x = NULL,
    y = "Interrow weed biomass (kg/ha)",
    title = "Interrow weed biomass",
    caption = ""
  ) +
  theme_classic(base_size = 20) +
  theme(
    axis.text.x  = element_text(lineheight = 0.95, margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    plot.title   = element_text(face = "bold"),
    plot.caption = element_text(size = 12)
  ) +
  coord_cartesian(clip = "off")

# 8) save figs
ggsave(
  filename = here::here("figs", "analysis", "fig_interrow_biomass_mowing_raw_2023.png"),
  width  = 7.5,
  height = 5.5,
  dpi    = 300
)

```

```{r}

m_inrow <- glmmTMB(
  inrow_weed_biomass_kg_ha ~ weed_trt + site_year + (1|site_year:block),
  family = tweedie(link = "log"),
  data   = soy
)

res_inrow <- DHARMa::simulateResiduals(m_inrow)
plot(res_inrow)
testDispersion(m_inrow)
testZeroInflation(m_inrow)

emm_in  <- emmeans(m_inrow, ~ weed_trt, type = "response")
cld_in  <- multcomp::cld(emm_in, adjust = "tukey", Letters = letters) %>%
  as.data.frame() %>%
  mutate(.group = trimws(.group))

in_df <- tidy_emm(as.data.frame(emm_in), ref_levels = mow_levels) %>%
  left_join(cld_in %>% select(weed_trt, .group), by = "weed_trt")

ggplot(in_df, aes(weed_trt, response, fill = weed_trt)) +
  geom_col(width = 0.75, color = "black") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.12) +
  geom_text(aes(y = ci_high * 1.04, label = .group), vjust = 0, size = 4) +
  scale_x_discrete(labels = c(
    "Rolled, no control"          = "Rolled,\nno control",
    "Rolled + mowing"             = "Rolled +\nmowing",
    "Rolled + high-residue cult." = "Rolled +\nHRC",
    "Tilled + mowing"             = "Tilled +\nmowing",
    "Tilled + cultivation"        = "Tilled +\ncultivation"
  )) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  labs(x = NULL, y = "In-row weed biomass (kg/ha)",
       title = "In-row weed biomass (pooled across site-years)") +
  theme_classic(base_size = 18)

```



### 6. Descriptive partition (stacked)

```{r}
## ------------------------------------------------------------------
## 0) common pieces
## ------------------------------------------------------------------
mow_levels <- c(
  "Rolled, no control",
  "Rolled + mowing",
  "Rolled + high-residue cult.",
  "Tilled + mowing",
  "Tilled + cultivation"
)

fill_cols <- c(
  "In-row"   = "#0072B2",
  "Interrow" = "#009E73"
)

## ------------------------------------------------------------------
## 1) RAW stacked components for 2023 Field V
## ------------------------------------------------------------------
comp_df <- soy_field_v_2023 |>
  group_by(weed_trt) |>
  summarise(
    inrow_mean    = mean(inrow_weed_biomass_kg_ha,    na.rm = TRUE),
    interrow_mean = mean(interrow_weed_biomass_kg_ha, na.rm = TRUE),
    .groups = "drop"
  ) |>
  tidyr::pivot_longer(
    cols = c(inrow_mean, interrow_mean),
    names_to = "position",
    values_to = "biomass"
  ) |>
  mutate(
    weed_trt = factor(weed_trt, levels = mow_levels),
    position = factor(
      position,
      levels = c("inrow_mean", "interrow_mean"),
      labels = c("In-row", "Interrow")
    )
  )

totals_df <- comp_df |>
  group_by(weed_trt) |>
  summarise(total_biomass = sum(biomass), .groups = "drop")

## ------------------------------------------------------------------
## 2) TOTAL CLD (caps) from total model
## ------------------------------------------------------------------
emm_tot <- emmeans(
  best_v23,
  specs = ~ weed_trt,
  type  = "response"
)

cld_tot <- multcomp::cld(
  emm_tot,
  adjust  = "none",
  Letters = LETTERS
) |>
  as.data.frame() |>
  mutate(
    .group   = trimws(.group),
    weed_trt = factor(weed_trt, levels = mow_levels)
  )

# reverse so tallest = A
totals_labeled <- totals_df |>
  left_join(cld_tot |> select(weed_trt, .group), by = "weed_trt") |>
  arrange(total_biomass)

orig_tot <- unique(totals_labeled$.group)
rev_tot  <- rev(orig_tot)
map_tot  <- setNames(rev_tot, orig_tot)

totals_labeled <- totals_labeled |>
  mutate(.group = map_tot[.group])

## ------------------------------------------------------------------
## 3) constituent CLDs
## ------------------------------------------------------------------
# in-row
emm_in <- emmeans(best_v23_inrow, ~ weed_trt, type = "response")
cld_in <- multcomp::cld(emm_in, adjust = "none", Letters = letters) |>
  as.data.frame() |>
  mutate(
    .group_in = trimws(.group),
    weed_trt  = factor(weed_trt, levels = mow_levels)
  ) |>
  select(weed_trt, .group_in)

# interrow
emm_ir <- emmeans(best_ir_v23, ~ weed_trt, type = "response")
cld_ir <- multcomp::cld(emm_ir, adjust = "none", Letters = letters) |>
  as.data.frame() |>
  mutate(
    .group_ir = trimws(.group),
    weed_trt  = factor(weed_trt, levels = mow_levels)
  ) |>
  select(weed_trt, .group_ir)

## ------------------------------------------------------------------
## 4) build stacked data + compute segment centers
## ------------------------------------------------------------------
stacked <- comp_df |>
  left_join(cld_in, by = "weed_trt") |>
  left_join(cld_ir, by = "weed_trt") |>
  mutate(seg_letter = dplyr::case_when(
    position == "In-row"   ~ .group_in,
    position == "Interrow" ~ .group_ir,
    TRUE                   ~ ""
  )) |>
  group_by(weed_trt) |>
  arrange(weed_trt, position) |>
  # cumulative height so we can get midpoints
  mutate(
    cum_height  = cumsum(biomass),
    prev_height = dplyr::lag(cum_height, default = 0),
    y_mid       = prev_height + biomass / 2,
    x_num       = as.numeric(weed_trt)
  ) |>
  ungroup()

## ------------------------------------------------------------------
## 5) plot
## ------------------------------------------------------------------
ggplot(stacked, aes(x = weed_trt, y = biomass, fill = position)) +
  geom_col(width = 0.75, color = "black") +
  # total (capital) letters on top
  geom_text(
    data = totals_labeled,
    aes(x = weed_trt, y = total_biomass * 1.04, label = .group),
    inherit.aes = FALSE,
    vjust = 0,
    size  = 4.4
  ) +
  # constituent (lowercase) letters OUTSIDE to the right
  geom_text(
    data = stacked,
    aes(x = x_num + 0.28, y = y_mid, label = seg_letter),
    inherit.aes = FALSE,
    size  = 3.6
  ) +
  scale_fill_manual(values = fill_cols, name = NULL) +
  scale_x_discrete(labels = \(x) str_replace_all(x, " ", "\n")) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = "Weed biomass (kg/ha)",
    title = "Partitioned weed biomass (in-row + interrow), Field V 2023",
    caption = "Bars = raw means (stacked); caps = Fisher from total model; lowercase (outside) = Fisher from in-row/interrow models."
  ) +
  theme_classic(base_size = 18) +
  theme(
    legend.position     = "bottom",
    plot.title.position = "plot",
    plot.title          = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.text.x         = element_text(size = 15, lineheight = 0.95),
    plot.caption        = element_text(hjust = 0, size = 11, color = "grey30"),
    plot.margin         = margin(5.5, 42, 5.5, 5.5)
  )
```

